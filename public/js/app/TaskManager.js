!function(e){"use strict";var t=Backbone.Model.extend({initialize:function(e,n){if(t.__super__.initialize.apply(this,arguments),void 0===n.userid)throw _.createError("MISSING_USER_ID","missing user id");if(void 0===n.sessionid)throw _.createError("MISSING_SESSION_ID","missing session id");this.userid=n.userid,this.sessionid=n.sessionid},url:SPA.ENVIRONMENT.spaSettings.touchpoints.router_rest,saveDiagnostic:function(){var e=this,t=SPA.ENVIRONMENT.spaSettings.touchpoints.diagnosticUrl,n=_.extend({p:"diagnostic"},e.toJSON());Q(jQuery.ajax({url:t,method:"POST",dataType:"json",headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},data:JSON.stringify(n)})).then(function(e){e.success||dfd.reject("Diagnostic communication error."),dfd.resolve(events)},function(e){dfd.reject("Diagnostic communication error.")}).fail(function(e){dfd.reject("Diagnostic communication error.")})}}),n=Backbone.Model.extend({defaults:{enabled:!0},initialize:function(e,t){var r=this;n.__super__.initialize.apply(r,arguments),r.dfd=Q.defer(),r.promise=r.dfd.promise,r.promise["finally"](function(){r.doFinally()})},generateId:function(){return SPA.Utils.guid()},resolve:function(e){var t=this;return t.onResolve(e),t.dfd.resolve.apply(t,arguments)},reject:function(e){var t=this;return console.log(t.identify()+" fail."),console.log(e),t.onReject(e),t.dfd.reject.apply(t,arguments)},notify:function(e){var t=this;return t.dfd.notify.apply(t,arguments),t.onNotify(e)},doFinally:function(){var e=this;e.onFinally()}},{objType:"OperationBase"}),r=n.extend({idAttribute:"opid",initialize:function(e,t){var n=this;return r.__super__.initialize.apply(n,arguments),t.owner?(n.owner=t.owner,void n.set({opid:n.generateId()},{silent:!0})):(n.reject(taskCtx.createReason("MISSING_OPERATION_OWNER")),!1)},validate:function(e){return e&&e.opid?void 0:"Invalid anonymous operation"},identify:function(){return"SPA Operation [type:"+this.get("type")+",type: "+this.id+"]"},onResolve:function(e){},onReject:function(e){},onNotify:function(e){this.owner.notify(e)},onFinally:function(){}},{objType:"Operation"}),i=n.extend({idAttribute:"tid",initialize:function(e,t){var n=this;if(i.__super__.initialize.apply(n,arguments),n.set({tid:n.generateId()},{silent:!0}),!t.manager)throw _.createError("MISSING_MANAGER");if(n.manager=t.manager,!t.client)throw _.createError("MISSING_CLIENT");n._client=t.client,n.operations=[],n.context=n._buildContext()},getClient:function(){return this._client},validate:function(e){return e&&e.type?void 0:"Invalid task"},identify:function(){return"SPA Task [type:"+this.get("type")+", tid: "+this.id+"]"},createOp:function(e,t){var n=this,i=new r(e,_.extendObj(t,{owner:n}));return n.operations.push(i),i},ctx:function(){return this.context},_buildContext:function(){var e=this;return{tid:e.id,type:e.get("type"),promise:e.promise,notify:function(t){e.notify(t)},newOp:function(t,n){return e.createOp(t,n)},createReason:function(t,n){return e.manager.createReason(t,n)},createInfo:function(t,n){return e.manager.createInfo(t,n)}}},onResolve:function(e){},onReject:function(e){console.log("ft",e),this.manager.notifyRejection(this,e)},onNotify:function(e){this.manager.notifyProgress(this,e)},onFinally:function(){var e=this;e.trigger("end",e)},fix:function(e){var t=this;return t.manager.fixReason(e)},handled:function(e){var t=this;return t.manager.markAsHandled(e)}},{objType:"Task"}),a=function(e,t){var n=this;n.application=e,n._currentSequenceTask=null,n._progressTask=null,n.sessionid=t.sessionid,n._loadRef=0};_.extend(a.prototype,{exec:function(e,t,n){var r=this;return r.createTask(e,{type:t}).then(function(e){try{var t=n(e.ctx());t&&t.then?t.then(function(t){e.resolve(t)},_.taskReject(e)):e.resolve(t)}catch(i){e.reject(r.createReason("EXEC_ERROR",i))}})},createTask:function(e,t,n){var r=this;if(!r.isStarted())throw r.createReason("TASKS_STOPPED","task manager not started.");if(!e||!t||!t.type)throw r.createReason("TASK_CREATE_ERROR","missing arguments.");return r.onCreateTask.apply(r,arguments)},onCreateTask:function(e,t,n){var r=this,i=t.type,a=r.createDefer();a.promise.fail(function(e){r.handleError(r.getMandate(),e)});try{switch(i){case"SESSION":r._createSessionTask(e,a,t,_.extend(n||{},{manager:r,system:!0}));case"TASK_MANAGER":r._createTaskManager(e,a,t,_.extend(n||{},{manager:r,system:!0}));break;case"SURROGATE":return r._createTaskModel(e,t,_.extend(n||{},{manager:r,system:!0}));default:r._createSimpleSequentialTask(e,a,t,n)}}catch(o){a.reject(r.createReason("TASK_CREATE_ERROR",o))}return a.promise},_createSimpleSequentialTask:function(e,t,n,r){var i=this,a=_.extend(r||{},{manager:i});i._currentSequenceTask?i._currentSequenceTask.promise.then(function(r){return i._currentSequenceTask=i._createTaskModel(e,n,a),t.resolve(i._currentSequenceTask)},function(r){i.isSequenceStarted()?t.resolve(i._currentSequenceTask=i._createTaskModel(e,n,a)):t.reject(i.createReason("TASKS_STOPPED",r))}):t.resolve(i._currentSequenceTask=i._createTaskModel(e,n,a))},_createSimpleSequentialProgressTask:function(e,t,n,r){var i=this,a=_.extend(r||{},{manager:i});i._progressTask?i._progressTask.promise.then(function(r){return i._progressTask=i._createTaskModel(e,n,a),t.resolve(i._progressTask)},function(r){i.isSequenceStarted()?t.resolve(i._progressTask=i._createTaskModel(e,n,a)):t.reject(i.createReason("TASKS_STOPPED",r))}):t.resolve(i._progressTask=i._createTaskModel(e,n,a))},isSequenceStarted:function(){return!0},_createTaskManager:function(e,t,n,r){var i=this;"TASK_MANAGER"===e.getRoles()?t.resolve(i._createTaskModel(e,n,r)):t.reject(i.createReason("UNAUTHORIZED_TASK"))},_createSessionTask:function(e,t,n,r){var i=this;i._sessionTask?t.reject(i.createReason("DUPLICATED_SESSION")):(i.sessionTask=i._createTaskModel(e,n,r),t.resolve(i.sessionTask))},_createTaskModel:function(e,t,n){var r=this,a=_.extend(n||{},{client:e}),o=new i(t,a);return n.system||(r.onTaskBegin(o,n),o.on("end",r.onTaskEnd,r,n)),o},createReason:function(e,t){var n=this;return{isReason:!0,code:e,inner:t,toString:function(){return e},match:function(){return n.matchReason.bind(n,this).apply(this,arguments)}}},createInfo:function(e,t){var n=!0,r=e;return t===!1?n=!1:r=e,{toLocalize:n,msg:r}},getIdentifier:function(){return"SIMPLE_MANAGER"},getRoles:function(){return"TASK_MANAGER"},createDefer:function(){return Q.defer()},start:function(e){var t=this;if(t.isDirector())return t._mandate=t.createDefer(),t._mandate.promise.fail(function(e){t.stopManager(),delete t._mandate}),t._surrogateTask=t.createTask(t,{type:"SURROGATE"}),window.onerror=function(e,n,r){t._surrogateTask.reject(t.createReason("WINDOW_ONERROR",{error:e,url:n,line:r}))},t.onStart(),Q.resolve(t);if(!e)throw t.createReason("MISSING_MANAGER");return t._superior=e,t._superior.createTask(t,{type:"TASK_MANAGER"}).then(function(e){return t._mandate=e,t._mandate.promise.fail(function(e){t.stopManager(),delete this._mandate}),t.onStart(),t})},notifyRejection:function(e,t){var n=this;n.onNotifyRejection.apply(n,arguments)},onNotifyRejection:function(e,t){var n,r=this;return(n=r._preFilterNotifiedRejection(e,t))?(r._showErrorAndStopManager(n),!1):void e.promise.fail(function(t){try{r.isFixed(t)||r.handleRejection(t)||r.handleError(e,t)}catch(n){r._unhandled(n)}return t})},_preFilterNotifiedRejection:function(e,t){var n;return"SESSION"===e.get("type")&&(n="invalid session"),n},_showErrorAndStopManager:function(e){var t=this;_.delay(function(){t.showMessage("error",e,{closable:!1})},0),t.stopManager(),SPA.disposed=!0},notifyProgress:function(e,t){var n=this;n.onNotifyProgress.apply(n,arguments)},onNotifyProgress:function(e,t){var n=this;t&&!n.isHandled(t)&&n.handleProgress(e,t)},handleProgress:function(e,t){var n=this,r=n.createDefer();r.promise.fail(function(e){n.handleError(n.getMandate(),e)});try{n._createSimpleSequentialProgressTask(n,r,{type:"__PROGRESS"})}catch(i){r.reject(n.createReason("PROGRESS_TASK_CREATE_ERROR",i))}r.promise.then(function(e){try{return e.resolve(n.onHandleProgress(t))}catch(r){return e.reject(n.createReason("JS_ERROR",r))}})},onStart:function(){},stopManager:function(){this.onStopManager()},isStarted:function(){return void 0!=this._mandate&&this._mandate.promise.isPending()},handleRejection:function(e){if(e.isReason)switch(e.code){case"TEST":return _.taskCriticalEscalation(e),!0;default:return!1}else if(SPA.Utils.isXHR(e))return!1},isFixable:function(e){return!0},showMessage:function(e,t,n){SPA.showInfo(e,null,t,n)},onHandleProgress:function(e){return Q(this.application.getLayout().notifyProgress(e))},onTaskBegin:function(e,t){var n=this;return"__PROGRESS"===e.get("type")?!1:t.hideLoading?(e.hideLoading=t.hideLoading,!1):(n._loadRef++,void n._ensureLoading(e))},onTaskEnd:function(e){var t=this;return"__PROGRESS"===e.get("type")||e.hideLoading===!0?!1:(t._loadRef--,void(0===t._loadRef&&t._stopLoading(e)))},_ensureLoading:function(e){var t=this;t.application.getLayout().startLoading()},_stopLoading:function(e){var t=this;t.application.getLayout().stopLoading()},onHandleError:function(e,t){var n=this;return Q.fcall(function(){if(!SPA.disposed){SPA.disposed=!0;var r=n.buildLogMessage(e,t);n._showFatalError(e,t,r),n.saveToLog(e,t,r)}})},_showFatalError:function(e,t,n){var r=this;try{if(!r.template){var i=SPA.templates.critical_error_tmpl;i.indexOf("{{-")>=0?r.template=r.getSafeGuardTemplate():r.template=_.template(i)}}catch(a){r.template=r.getSafeGuardTemplate()}var o=JSON.stringify(r.getVisibleDetails(n)),s=r.application.getConfig().sync.conventions.diagnostics.getVisibleDetails(e,t),c=r.template({task:e,reason:t,diagnostics:s,details:o});r.application.getLayout().showError({content:c,overlayClosesOnClick:!1,appendLocation:"#critical_alert"})},getVisibleDetails:function(e){try{return SPA.isDebug()?e:{errorCode:e.id}}catch(t){return{errorCode:"unknown"}}},getSafeGuardTemplate:function(){return _.template('<div class="modal-header">\r\n        <h4>Critical error</h4>\r\n        <p>Sorry, some critical error occurred and the application can\'t continue.</p>\r\n        <p><%=reason.code%></p>\r\n    </div>\r\n    <div class="modal-body">\r\n        <h2>Please, what are you doing when the error occurred ?</h2>\r\n        <textarea rows="3" cols="175" placeholder="Error description"></textarea>\r\n        <br/>\r\n        <div><a href="#" id="btnSend">Send</a></div>\r\n    </div>\r\n    <div class="modal-footer">\r\n        <div class="details">\r\n            <a href="javascript:void(0)" onclick="jQuery(\'#modal_view_details\').show();" class="btn btn-primary btn-circle"></a>\r\n            Details\r\n        </div>\r\n        <div class="reload">\r\n            <a href="#" class="btn btn-reload"  id="btnReload">\r\n                Reload\r\n            </a>\r\n            <a href="#" id="btnHome" data-dismiss="modal" class="btn btn-reload">Home</a>\r\n        </div>\r\n    </div>\r\n    <div id="modal_view_details" class="modal-footer view-details">\r\n        <textarea rows="5" cols="175"><%=details%></textarea>\r\n    </div>')},saveToLog:function(e,n,r){var i=this,a=r&&r.id?r.id:SPA.Utils.guid(),o=SPA.getProfile().user,s=i.application.getConfig().sync.conventions.diagnostics.log.errors.getLogTitle(e,"SPA_FATAL_ERROR",n,o,"TODO_SPA_sessionid",i._shortenizeToken(i.sessionid)),c=new t({logid:a,type:"ERROR",title:s,details:r||i.buildLogMessage(e,n)},{userid:o,sessionid:i.sessionid});return Q(c.saveDiagnostic())},_shortenizeToken:function(e){return e.length>10?e.slice(0,5)+"..."+e.slice(e.length-5,e.length):e},buildLogMessage:function(e,t){var n=this,r=SPA.getProfile().user;return{id:SPA.Utils.guid(),ctx:{env:"TODO",isDev:SPA.ENVIRONMENT.serverSettings.isDevEnvironment,mode:"BUILD_MODE",userid:r,sessionid:n.sessionid,agent:navigator.userAgent,href:document.location.href,error_time:(new Date).toString("yyyy-MM-ddTHH:mm:ss")},details:{tid:e.id,type:e.get("type"),code:t.code||"-",stack:n.buildStackTrace(t)}}},buildStackTrace:function(e){for(var t=this,n=[],r=e,i=!1;!i;)r?(n.push(t.formatStackEntry(r)),r.isReason?r=r.inner:i=!0):i=!0;return n},formatStackEntry:function(e){if(e.isReason){var t=e.stack;return t||e.toString()}if(SPA.Utils.isXHR(e))return{failedUrl:e.failedUrl,readyState:e.readyState,status:e.status,statusText:e.statusText};var t=e.stack;return t||e},errRestart:function(e){window.location.hash="home",window.location.reload()},errReload:function(e){window.location.reload()},sendErrorFeedback:function(e){var t=this;_.template(SPA.Config.support.errorFeedback.subjectTemplate,{}),_.template(SPA.Config.support.errorFeedback.bodyTemplate,{userid:SPA.getProfile().user,etime:(new Date).toString("u"),feedback:$(t.$("textarea")[0]).val(),trace:$(t.$("textarea")[1]).val()});t._fakeSend()},_fakeSend:function(){var e=this,t=e.$("#btnSend").text();e.$("#btnSend").text("Sending feedback..."),_.delay(function(){e.$("#btnSend").text(t),$(e.$("textarea")[0]).val("")},2e3)},fixReason:function(e){var t=this;try{return t.isFixable(e)?(e.__fixed__=!0,t.application.getLayout().stopLoading(),Q.resolve(t)):Q.reject(e)}catch(n){return Q.reject(n)}},markAsHandled:function(e){e.__handled=!0},isHandled:function(e){return e&&e.__handled===!0},isFixed:function(e){return e&&e.__fixed__===!0},isDirector:function(){return!0},getSuperior:function(){return this._superior},getMandate:function(){return this._mandate},matchReason:function(e,t){var n,r=this,i=[],a=e;_.isString(t)?i.push(t):i=_.clone(t);for(var o=0;o<i.length&&a;o++){var s=i[o];if(!r.matchErrorCode(a,s))return!1;n=a,a=a.inner}return n},matchErrorCode:function(e,t){return e&&e.code===t},handleError:function(e,t){var n=this;if(e&&e.getClient){var r=e.getClient();if(r&&r.safeGuard)try{r.safeGuard()}catch(i){console.log("Some error during safeGuard of client : "+r)}}var a=e||n._surrogateTask;n.onHandleError(a,t).then(function(e){n.onAfterHandleError(t)},function(e){n.onUnhandledError(e)})},onAfterHandleError:function(e){var t=this;t.getMandate().reject(e)},onUnhandledError:function(e){var t=this;t._unhandled(e)},_unhandled:function(e){},onStopManager:function(){Backbone.history.stop()},onClose:function(){}}),e.TM=new a(e,{sessionid:_.getSessionId()})}(SPA.Application("TimeLogs"));